# Тригерные функции и триггеры

`Триггерная функция` — это обычная функция в PostgreSQL (функция пишется на PL/pgSQL или другом процедурном языке), 
которая специально предназначена для использования в триггерах. Такая функция должна возвращать специальный тип TRIGGER.

Пример создания триггерной функции:
```sql
-- Предположим, у нас есть таблица orders, и мы хотим вести журнал всех изменений в этой таблице. 
-- Мы создадим триггерную функцию и триггер для выполнения этой задачи
CREATE OR REPLACE FUNCTION record_changes()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO orders_log(order_id, old_amount, new_amount, changed_on)
    VALUES (NEW.order_id, OLD.amount, NEW.amount, now());
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

`Триггер` — Триггер — это объект базы данных, который указывает, когда должна быть выполнена триггерная функция. 
Триггеры могут быть настроены на выполнение до или после событий INSERT, UPDATE, DELETE, а также для каждого события STATEMENT или ROW.

Каждый триггер связан с таблицей и активируется, когда в этой таблице происходят определенные события, такие как
- вставка (INSERT),
- обновление (UPDATE),
- удаление (DELETE) записей.

Пример создания триггера:
```sql
-- После каждого обновления записи в таблице orders, триггер orders_change_trigger активирует функцию record_changes, 
-- которая записывает изменения в таблицу orders_log.

CREATE TRIGGER orders_change_trigger
AFTER UPDATE ON orders
FOR EACH ROW EXECUTE FUNCTION record_changes();
```

Типы триггеров:

	1.	BEFORE триггеры: Выполняются до выполнения основного действия (вставки, обновления или удаления).
	2.	AFTER триггеры: Выполняются после выполнения основного действия.
	3.	INSTEAD OF триггеры: Используются только с представлениями и позволяют заменить выполнение основного действия на выполнение триггерной функции.

Триггер состоит из двух частей: 
- триггерной функции, которая определяет действия, выполняемые при срабатывании триггера 
- самого триггера, который определяет, при каких событиях эта функция будет вызвана. 


## Этапы Создания и Активации Триггера

1. Определение Триггерной Функции
   - Написание триггерной функции, которая определяет логику, выполняемую при срабатывании триггера.
   - Использование PL/pgSQL для создания тела функции.
2. Создание Триггера
   - Определение триггера с помощью команды CREATE TRIGGER.
   - Указание событий (INSERT, UPDATE, DELETE), при которых триггер будет активирован.
3. События Активации Триггера
   - Происходят изменения в таблице (например, добавление или обновление записи).
   - Эти события инициируют активацию триггера.
4. Действия Триггера
   - Триггер вызывает триггерную функцию.
   - Выполнение заданных в функции действий (например, запись в журнал изменений).



Пример BEFORE UPDATE триггера: 

```sql
-- Триггерная функция log_update() будет вызываться до того, как обновление будет применено к строке в таблице orders
CREATE TRIGGER before_order_update
BEFORE UPDATE ON orders
FOR EACH ROW EXECUTE FUNCTION log_update();
```

Пример AFTER UPDATE триггера: 
```sql
-- Триггерная функция log_update() будет вызываться после того, как обновление будет применено к строке в таблице orders
CREATE TRIGGER orders_change_trigger
AFTER UPDATE ON orders
FOR EACH ROW EXECUTE FUNCTION record_changes();
```

Пример AFTER INSERT триггера: 
```sql
CREATE TRIGGER after_order_insert
AFTER INSERT ON orders
FOR EACH ROW EXECUTE FUNCTION log_update();
```

Пример AFTER UPDATE c OF amount триггера: 
```sql
--OF amount, означает, что триггер будет срабатывать только при изменении столбца amount в таблице orders
CREATE TRIGGER after_order_amount_update
AFTER UPDATE OF amount ON orders 
FOR EACH ROW EXECUTE FUNCTION log_update();
 ```

Пример AFTER DELETE триггера: 
```sql
CREATE TRIGGER after_order_delete
AFTER DELETE ON orders
FOR EACH ROW EXECUTE FUNCTION log_update();
```


Пример AFTER INSERT, UPDATE, DELETE триггера:
```sql
CREATE TRIGGER after_order_change
AFTER INSERT OR UPDATE OR DELETE ON orders
FOR EACH ROW EXECUTE FUNCTION log_update();
```



# DDL Triggers в PostgreSQL

В PostgreSQL существуют триггеры, которые срабатывают на события DDL (Data Definition Language), такие как CREATE, ALTER, DROP, GRANT, REVOKE и другие команды, 
которые изменяют структуру базы данных. Эти события могут быть перехвачены для выполнения дополнительных действий до или после выполнения команды.

## ddl_command_start
Это событие происходит перед выполнением команд CREATE, ALTER, DROP, SECURITY LABEL, COMMENT, GRANT, REVOKE и SELECT INTO.

Пример использования: Логирование всех DDL команд до их выполнения.
```sql
CREATE OR REPLACE FUNCTION log_ddl_start() RETURNS event_trigger AS $$
BEGIN
    RAISE NOTICE 'DDL Command Start: %', tg_tag;
END;
$$ LANGUAGE plpgsql;

CREATE EVENT TRIGGER log_ddl_start_trigger
ON ddl_command_start
EXECUTE FUNCTION log_ddl_start();
```

## ddl_command_end
Это событие происходит после выполнения команд CREATE, ALTER, DROP, SECURITY LABEL, COMMENT, GRANT, REVOKE и SELECT INTO.

Пример использования: Логирование всех DDL команд после их выполнения.
```sql
CREATE OR REPLACE FUNCTION log_ddl_end() RETURNS event_trigger AS $$
BEGIN
    RAISE NOTICE 'DDL Command End: %', tg_tag;
END;
$$ LANGUAGE plpgsql;

CREATE EVENT TRIGGER log_ddl_end_trigger
ON ddl_command_end
EXECUTE FUNCTION log_ddl_end();
```

## table_rewrite
Это событие происходит перед тем, как таблица будет переписана командами ALTER TABLE и ALTER TYPE. 
Это может быть полезно для выполнения действий перед значительными изменениями структуры таблицы, такими как изменение типа данных столбца.

Пример использования: Логирование переписывания таблицы.
```sql
CREATE OR REPLACE FUNCTION log_table_rewrite() RETURNS event_trigger AS $$
BEGIN
    RAISE NOTICE 'Table Rewrite: %', tg_tag;
END;
$$ LANGUAGE plpgsql;

CREATE EVENT TRIGGER log_table_rewrite_trigger
ON table_rewrite
EXECUTE FUNCTION log_table_rewrite();
```

## sql_drop
Это событие происходит перед событием ddl_command_end для любой операции, которая удаляет объекты базы данных (например, команды DROP).

Пример использования: Логирование всех операций удаления объектов.
```sql
CREATE OR REPLACE FUNCTION log_sql_drop() RETURNS event_trigger AS $$
BEGIN
    RAISE NOTICE 'SQL Drop: %', tg_tag;
END;
$$ LANGUAGE plpgsql;

CREATE EVENT TRIGGER log_sql_drop_trigger
ON sql_drop
EXECUTE FUNCTION log_sql_drop();
```
# EXPLAIN

`EXPLAIN` используется для анализа плана выполнения запроса и понимания того, как запрос будет выполнен базой данных.

План выполнения включает в себя информацию о том, какие индексы будут использованы, какие методы соединения и 
сортировки будут применены, какие таблицы будут отсканированы и в каком порядке будут выполнены различные операции.

```sql
EXPLAIN SELECT * FROM table_name WHERE condition;
```

### Ключевые команды EXPLAIN:
- VERBOSE: Показывает более подробную информацию о плане выполнения запроса, включая описание каждой операции.
    ```sql
    EXPLAIN VERBOSE SELECT * FROM table_name WHERE condition;
    ```
- COSTS: Показывает оценку стоимости каждой операции в плане выполнения запроса, что помогает определить, насколько дорого будет выполнение запроса.
    ```sql
    EXPLAIN (COSTS true) SELECT * FROM table_name WHERE condition;
    ```
- BUFFERS: Показывает информацию об использовании буферов в плане выполнения запроса, включая количество буферов, 
используемых каждой операцией и типы буферов, такие как shared_buffers, temp_buffers и disk_buffers.
  ```sql
  EXPLAIN (BUFFERS true) SELECT * FROM table_name WHERE condition;
  ```
- TIMING: Показывает информацию о времени выполнения каждой операции в плане выполнения запроса, включая общее время выполнения и время каждой отдельной операции.
  ```sql
  EXPLAIN (TIMING true) SELECT * FROM table_name WHERE condition;
  ```
- SUMMARY: Показывает краткий обзор плана выполнения запроса, который включает в себя основные параметры и статистику о времени выполнения и использовании ресурсов.
  ```sql
  EXPLAIN (SUMMARY true) SELECT * FROM table_name WHERE condition;
  ```
- FORMAT: Позволяет выбирать формат вывода результатов EXPLAIN, такие как TEXT, JSON, XML и т. д.
  ```sql
  EXPLAIN (FORMAT JSON) SELECT * FROM table_name WHERE condition;
  ```

<br>

Пример записи в одном запросе: 
```sql
EXPLAIN (VERBOSE, COSTS, BUFFERS, TIMING) SELECT * FROM table_name WHERE condition;
```

### Интерпретация результатов:
В плане можно увидеть порядок выполнения запроса и какие ресурсы будут использоваться.

Нужно обращать внимание на:
```text
- использование индексов,
- методы соединения
- сортировку
- на время выполнения 
- на использование буферов
```


# ANALYZE

`ANALYZE` используется для сбора статистических данных о таблицах и индексах. 
Эти статистические данные позволяют оптимизатору запросов принимать более эффективные решения при выборе планов выполнения запросов.

```sql
ANALYZE table_name;
```

Когда выполняется команда ANALYZE для таблицы, PostgreSQL сканирует данные в этой таблице и собирает статистику о 
распределении значений в столбцах, количестве строк, а также информацию об индексах.

Собранная статистика позволяет оптимизатору запросов принимать более эффективные решения при выборе планов выполнения запросов. 
Например: оптимизатор может использовать эту информацию для выбора подходящего индекса или 
определения порядка соединения таблиц для ускорения выполнения запросов.

Рекомендуется выполнять ANALYZE после загрузки больших объемов данных в таблицу, 
после выполнения значительных изменений структуры таблицы или индексов, 
а также периодически для обновления статистики и поддержания оптимальной производительности запросов.

### Комбинация с другими командами:
ANALYZE может использоваться с командой EXPLAIN для анализа и оптимизации запросов.
Рекомендуется использовать ANALYZE с таблицами, которые часто используются в запросах, чтобы обеспечить актуальность статистических данных.

```sql
EXPLAIN ANALYZE SELECT * FROM table_name WHERE condition;

```


### Полезный материал:
https://postgrespro.ru/docs/postgresql/16/performance-tips

https://habr.com/ru/companies/tensor/articles/790282/
https://www.youtube.com/playlist?list=PLt0vzWoDuwcTdFnp-QWtx2yEvKMDlPw7l

https://www.sql-ex.ru/blogs/?/Poluchenie_plana_vypolneniJa_zaprosa_v_PostgreSQL.html


## Рекомендации для оптимизации работы с базами данных.

1) Индексы: <br>
Создавать индексы на столбцы, которые часто используются в запросах.
Создавать многоколоночные индексы для запросов с условиями по нескольким столбцам.
Избегать создания слишком многих индексов, т. к. это может привести к избыточной нагрузке на базу данных при изменении данных.


2) Анализ запросов: <br>
Использовать EXPLAIN для анализа плана выполнения запросов.
Проводить анализ использования индексов, методов соединения и сортировки, использования буферов и времени выполнения операций.


3) Оптимизация запросов: <br>
Избегай операций, которые могут привести к полному сканированию таблицы, если это возможно.
Используйте индексы и оптимизированные запросы для выборки только необходимых данных.


4) Анализ производительности: <br>
Используй инструменты мониторинга производительности, такие как pg_stat_statements в PostgreSQL, для отслеживания наиболее часто выполняемых запросов и их времени выполнения.
Проверяй статистику использования ресурсов базы данных, таких как временные файлы и объем использованной памяти.


5) Оптимизация инфраструктуры: <br>
Подбирай аппаратное обеспечение под нагрузку вашей базы данных, включая выбор соответствующей памяти, процессоров и дисков.
Рассмотри возможность использования кэширования запросов и результатов для снижения нагрузки на БД.


6) Партиционирование и шардинг: <br>
Рассмотри возможность партиционирования таблиц по времени или значению, чтобы снизить объем данных, обрабатываемых одним запросом.
Используй шардинг для распределения данных по разным серверам, чтобы уменьшить нагрузку на каждый отдельный сервер и улучшить масштабируемость.


7) Регулярное обслуживание: <br>
Выполняй регулярное административное обслуживание базы данных, такое как анализ и оптимизация индексов, сбор статистики и очистка временных таблиц.